<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DFA String Checker</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <!-- Container utama aplikasi -->
  <div class="container">
    <!-- Header aplikasi -->
    <div class="header">
      <h1>ðŸ§ª DFA String Checker</h1>
      <p>Periksa apakah suatu string diterima oleh DFA yang diberikan.</p>
    </div>

    <!-- Form input DFA dan string -->
    <div class="main-content">
      <div class="dfa-section">
        <div class="form-group">
          <label for="states">States:</label>
          <input type="text" id="states" placeholder="Contoh: q0 q1 q2">
          <div class="help-text">Pisahkan dengan spasi</div>
        </div>

        <div class="form-group">
          <label for="alphabet">Alphabet:</label>
          <input type="text" id="alphabet" placeholder="Contoh: a b">
          <div class="help-text">Pisahkan dengan spasi</div>
        </div>

        <div class="form-group">
          <label for="start">Start State:</label>
          <input type="text" id="start" placeholder="Contoh: q0">
        </div>

        <div class="form-group">
          <label for="final">Final States:</label>
          <input type="text" id="final" placeholder="Contoh: q1 q2">
          <div class="help-text">Pisahkan dengan spasi</div>
        </div>

        <div class="form-group">
          <label>Transition Functions:</label>
          <div id="transitions" class="transitions-container">
            <div class="help-text">Isi states dan alphabet terlebih dahulu</div>
          </div>
        </div>

        <div class="form-group">
          <label for="inputString">Input String:</label>
          <input type="text" id="inputString" placeholder="Contoh: abba">
        </div>

        <div class="btn-container">
          <button id="checkBtn" class="btn-check">Check String</button>
        </div>

        <!-- Container untuk hasil simulasi -->
        <div id="result" class="result-container"></div>

        <!-- Tabel transisi dan langkah simulasi -->
        <div id="transition-table-container" class="transition-table-container">
          <h3>Langkah-langkah Simulasi DFA</h3>
          <div id="simulation-steps"></div>
          <h4>Tabel Transisi</h4>
          <table id="transition-table" class="transition-table">
            <thead>
              <tr>
                <th>State</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>

        <!-- Visualisasi DFA -->
        <div id="dfa-visualization-container">
          <h3>Visualisasi DFA</h3>
          <img id="dfa-image" alt="DFA Visualization" />
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript untuk logika aplikasi -->
  <script>
    // Fungsi untuk menghasilkan input transisi dinamis
    function generateTransitions() {
      const states = document.getElementById("states").value.trim().split(/\s+/).filter(s => s);
      const alphabet = document.getElementById("alphabet").value.trim().split(/\s+/).filter(s => s);
      const container = document.getElementById("transitions");

      if (states.length === 0 || alphabet.length === 0) {
        container.innerHTML = '<div class="help-text">Isi states dan alphabet terlebih dahulu</div>';
        return;
      }

      container.innerHTML = '';
      states.forEach(state => {
        alphabet.forEach(symbol => {
          const row = document.createElement("div");
          row.className = "transition-row";
          row.innerHTML = `
            <input type="text" value="${state}" readonly>
            <div class="arrow">â†’ (${symbol})</div>
            <input type="text" id="trans_${state}_${symbol}" placeholder="Next state">
          `;
          container.appendChild(row);
        });
      });
    }

    // Event listener untuk input states dan alphabet
    ['states', 'alphabet'].forEach(id => {
      document.getElementById(id).addEventListener('input', generateTransitions);
    });

    // Fungsi untuk mengumpulkan data DFA dari form
    function collectDFA() {
      const states = document.getElementById("states").value.trim().split(/\s+/).filter(s => s);
      const alphabet = document.getElementById("alphabet").value.trim().split(/\s+/).filter(s => s);
      const start_state = document.getElementById("start").value.trim();
      const final_state = document.getElementById("final").value.trim().split(/\s+/).filter(s => s);

      const transitions = {};
      states.forEach(state => {
        transitions[state] = {};
        alphabet.forEach(symbol => {
          const next = document.getElementById(`trans_${state}_${symbol}`).value.trim();
          if (next) transitions[state][symbol] = next;
        });
      });

      return {
        states,
        alphabet,
        start_state,
        final_state,
        transitions
      };
    }

    // Fungsi untuk mensimulasikan DFA dengan langkah-langkah
    function simulateDFAWithSteps(dfa, inputString) {
      let currentState = dfa.start_state;
      const steps = [];
      const transitions = dfa.transitions;
      
      steps.push({
        step: 0,
        symbol: '',
        currentState: currentState,
        nextState: currentState,
        action: 'Start'
      });

      for (let i = 0; i < inputString.length; i++) {
        const symbol = inputString[i];
        
        if (!dfa.alphabet.includes(symbol)) {
          return {
            accepted: false,
            steps: steps,
            error: `Symbol '${symbol}' tidak ada dalam alphabet`
          };
        }

        if (!transitions[currentState] || !transitions[currentState][symbol]) {
          return {
            accepted: false,
            steps: steps,
            error: `Tidak ada transisi dari state '${currentState}' dengan symbol '${symbol}'`
          };
        }

        const nextState = transitions[currentState][symbol];
        steps.push({
          step: i + 1,
          symbol: symbol,
          currentState: currentState,
          nextState: nextState,
          action: `Read '${symbol}'`
        });

        currentState = nextState;
      }

      const accepted = dfa.final_state.includes(currentState);
      return {
        accepted: accepted,
        steps: steps,
        finalState: currentState
      };
    }

    // Fungsi untuk membuat tabel transisi
    function createTransitionTable(dfa) {
      const table = document.getElementById('transition-table');
      const thead = table.querySelector('thead tr');
      const tbody = table.querySelector('tbody');

      thead.innerHTML = '<th>State</th>';
      tbody.innerHTML = '';

      dfa.alphabet.forEach(symbol => {
        thead.innerHTML += `<th>${symbol}</th>`;
      });

      dfa.states.forEach(state => {
        const row = document.createElement('tr');
        let stateLabel = state;
        if (state === dfa.start_state) stateLabel += ' (start)';
        if (dfa.final_state.includes(state)) stateLabel += ' (final)';
        
        row.innerHTML = `<td><strong>${stateLabel}</strong></td>`;
        
        dfa.alphabet.forEach(symbol => {
          const nextState = dfa.transitions[state] && dfa.transitions[state][symbol] 
            ? dfa.transitions[state][symbol] 
            : '-';
          row.innerHTML += `<td>${nextState}</td>`;
        });
        
        tbody.appendChild(row);
      });
    }

    // Fungsi untuk menampilkan langkah-langkah simulasi
    function displaySimulationSteps(steps, error = null) {
    const container = document.getElementById('simulation-steps');
    container.innerHTML = '';

    if (error) {
        container.innerHTML = `<div class="step-indicator" style="background-color: #f8d7da; color: #721c24;">
        <strong>Kesalahan:</strong> ${error}
        </div>`;
        return;
    }

    steps.forEach((step, index) => {
        const stepDiv = document.createElement('div');
        stepDiv.className = 'step-indicator';
        
        if (step.action === 'Start') {
        stepDiv.innerHTML = `<strong>Langkah ${step.step}:</strong> Mulai dari status <strong>${step.currentState}</strong>`;
        } else {
        stepDiv.innerHTML = `<strong>Langkah ${step.step}:</strong> ${step.action.replace('Read', 'Baca')} â†’ Transisi dari <strong>${step.currentState}</strong> ke <strong>${step.nextState}</strong>`;
        }
        
        container.appendChild(stepDiv);
    });
    }
    // Fungsi untuk visualisasi DFA dengan request ke backend
    async function visualizeDFA(dfa) {
      try {
        const response = await fetch('http://localhost:5000/visualize_dfa', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ dfa: dfa })
        });

        const data = await response.json();
        if (data.error) {
          throw new Error(data.error);
        }

        const imgElement = document.getElementById('dfa-image');
        imgElement.src = `data:image/png;base64,${data.image}`;
        imgElement.style.display = 'block';
        
      } catch (error) {
        console.error('Visualization error:', error);
        const imgElement = document.getElementById('dfa-image');
        imgElement.style.display = 'none';
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
          width: 400px; 
          height: 300px; 
          background: #fee2e2; 
          border: 2px solid #991b1b; 
          display: flex; 
          align-items: center; 
          justify-content: center; 
          margin: 0 auto; 
          border-radius: 8px;
          font-family: monospace;
          color: #991b1b;
          text-align: center;
        `;
        errorDiv.innerHTML = `Gagal memuat visualisasi:<br>${error.message}`;
        imgElement.parentNode.insertBefore(errorDiv, imgElement);
      }
    }

    // Event listener untuk tombol check
    document.getElementById("checkBtn").addEventListener("click", async () => {
      const btn = document.getElementById("checkBtn");
      const result = document.getElementById("result");
      const tableContainer = document.getElementById("transition-table-container");
      const visualContainer = document.getElementById("dfa-visualization-container");

      btn.disabled = true;
      btn.innerHTML = 'Checking... <span class="loading"></span>';
      result.classList.remove('show');
      tableContainer.classList.remove('show');
      visualContainer.classList.remove('show');

      try {
        const dfa = collectDFA();
        const input_string = document.getElementById("inputString").value.trim();

        if (dfa.states.length === 0 || dfa.alphabet.length === 0 || !dfa.start_state) {
          throw new Error('Mohon isi states, alphabet, dan start state dengan benar');
        }

        const simulation = simulateDFAWithSteps(dfa, input_string);

        result.innerHTML = simulation.error 
          ? `Error: ${simulation.error}`
          : `String "${input_string}" ${simulation.accepted ? 'diterima' : 'ditolak'} oleh DFA`;
        result.className = `result-container ${simulation.accepted ? 'result-equivalent' : 'result-not-equivalent'} show`;

        createTransitionTable(dfa);
        displaySimulationSteps(simulation.steps, simulation.error);
        tableContainer.classList.add('show');

        if (simulation.accepted) {
          await visualizeDFA(dfa);
          visualContainer.classList.add('show');
        }

      } catch (error) {
        result.innerHTML = `Error: ${error.message}`;
        result.className = 'result-container result-not-equivalent show';
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'Check String';
      }
    });
  </script>
</body>
</html>